<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="utf-8" />
        <title>v0.1</title>
        <link rel="stylesheet" type="text/css" href="styles/default.css" />
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  	    <script type="text/javascript" src="js/flot/jquery.flot.js"></script>
        <script type="text/javascript" src="js/flot/jquery.flot.pie.js"></script>
        <script type="text/javascript" src="js/jquery.loadingdotdotdot.js"></script>
        <script type="text/javascript">
        $(function(){
            
			var Twitter = {
			  param : "?q=%231998282&result_type=recent&rpp=100",
			  refreshRate : 10000,
			  getTweets : function(){
			  
			  }
			};
			
			
			
			var refreshRate = 10000; // 10 sec //default: 300000 (5 minutes)
            var param = "?q=%231998282&result_type=recent&rpp=100"; //query is '#1998282', rpp is amount of results (100 is max)
            
			var votes = [
                { label: "H5c", data: 0  },
                { label: "H5d", data: 0  },
                { label: "H5e", data: 0  }
            ];

            var plotChart = function( data ) {
                $.plot($("#pieChart"), data, {
                    series : { pie: { show: true } },
                    grid: { hoverable : true, clickable : true}
                });
            };

            var getTweets = function( parameters ) {
                statusMessage('show');
                $.getJSON("http://search.twitter.com/search.json" + parameters + "&callback=?", function( data ){
                    param = data.refresh_url + "&rpp=100"; //data.refresh.url contains the id of the newest tweet. When checking for new tweets it will use that id to check if there are new ones.
                    parseTweets(data);
                    statusMessage('hide');
                });
            };

            var parseTweets = function( data ) {
                if ( data.results.length > 0 ) {
                    for ( var i = 0, max = data.results.length; i < max; i++ ) {
                        var vote = cleanTweet(data.results[i].text).toLowerCase();
                        
                        for ( var b = 0, max2 = votes.length; b < max2; b++ ) { //Go through all the teams to add a vote to that team name.
                            teamLabel = votes[b].label.toLowerCase();
                                
                            if ( vote.indexOf(teamLabel) != -1 ) {
                                votes[b].data = votes[b].data + 1;
                                break;
                            } else {
                                continue;
                            }                        
                        }           
                    }
                    plotChart(votes);
                }
            };

            // RUN
            getTweets(param);

            $("#pieChart").bind("plothover", pieHover);
            $("#pieChart").bind("plotclick", pieClick);
        
            setInterval(function(){
                getTweets(param);
            }, refreshRate);
        });

        function pieHover( event, pos, obj ) {
	        if (!obj) return;

	        percent = parseFloat(obj.series.percent).toFixed(2);
            $("#hover").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');
        }

        function pieClick( event, pos, obj ) {
            if (!obj) return;

	        percent = parseFloat(obj.series.percent).toFixed(2);
            alert(''+obj.series.label+': '+percent+'%');
        }

        function cleanTweet ( tweet ) {
            var text = tweet.split("#");
            return $.trim(text[0].replace(/[^a-zA-Z 0-9]+/g,''));
        }

        function statusMessage( visibility ) {
 console.log('load');            if ( visibility === 'show' ) {
                $("#status").show();
                $("#status div").Loadingdotdotdot({
                    "speed": 120,
                    "maxDots": 4
                });
            } else if ( visibility === 'hide' ) {
console.log('finish');
                $("#status div").Loadingdotdotdot("stop");
                $("#status").hide();
            }
        }
        </script>        
        <!--[if lt IE 9]> 
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> 
        <![endif]-->
    </head>
    <body>
        <div id="message">Tweet "<b>klas #1998282</b>" om te stemmen</div>
        
        <section id="graph">
            <div id="pieChart"></div>
            <div id="hover"></div>
        </section>
        
        <div id="status"><div><!-- Loading text --></div></div>
    </body>
</html>
